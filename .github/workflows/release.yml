name: Release 
 
on: 
  push: 
    tags: 
      - 'v*' 
 
jobs: 
  release: 
    runs-on: windows-latest 
    permissions: 
      contents: write 
    steps: 
      - name: Checkout 
        uses: actions/checkout@v4 
 
      - name: Set up JDK 17 
        uses: actions/setup-java@v4 
        with: 
          java-version: '17' 
          distribution: 'zulu' 
          cache: 'gradle' 
 
      - name: Grant execute permission for gradlew 
        run: git update-index --chmod=+x gradlew 
 
      - name: Decode Keystore 
        id: decode_keystore 
        shell: pwsh 
        env: 
          KEYSTORE_BASE64: ${{ secrets.ANDROID_SIGNING_KEYSTORE_BASE64 }} 
        run: | 
          if (-not [string]::IsNullOrEmpty($env:KEYSTORE_BASE64)) { 
            $bytes = [System.Convert]::FromBase64String($env:KEYSTORE_BASE64) 
            [IO.File]::WriteAllBytes("composeApp/release.keystore", $bytes) 
            Write-Host "Keystore decoded successfully." 
          } else { 
            Write-Error "ANDROID_SIGNING_KEYSTORE_BASE64 is empty!" 
            exit 1 
          } 
 
      - name: Build and Package 
        # 同时打包 Windows (Exe, Msi) 和 Android Release APK
        run: ./gradlew :composeApp:packageReleaseExe :composeApp:packageReleaseMsi :composeApp:assembleRelease --no-daemon 
        env: 
          ANDROID_SIGNING_STORE_FILE: "release.keystore" 
          ANDROID_SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }} 
          ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }} 
          ANDROID_SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }} 
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m" 
 
      - name: Prepare Artifacts 
        shell: pwsh 
        run: | 
            mkdir release-artifacts 
            # Copy EXE from release folder 
            if (Test-Path composeApp/build/compose/binaries/main-release/exe/*.exe) { 
              copy composeApp/build/compose/binaries/main-release/exe/*.exe release-artifacts/ 
            } 
            # Copy MSI from release folder 
            if (Test-Path composeApp/build/compose/binaries/main-release/msi/*.msi) { 
              copy composeApp/build/compose/binaries/main-release/msi/*.msi release-artifacts/ 
            } 
            # Copy Android APK 
            if (Test-Path composeApp/build/outputs/apk/release/*.apk) { 
              copy composeApp/build/outputs/apk/release/*.apk release-artifacts/ 
            } 
 
      - name: Create Release 
        uses: softprops/action-gh-release@v1 
        with: 
          files: | 
            release-artifacts/*.exe 
            release-artifacts/*.msi 
            release-artifacts/*.apk 
          draft: false 
          prerelease: false 
        env: 
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
